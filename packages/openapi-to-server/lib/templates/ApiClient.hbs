import { AxiosInstance } from 'axios';

{{#each components.schemas}}
  export type {{@key}} = {{render_template 'JsonSchema.hbs' this~}};
{{/each}}

{{#each paths as |path url|}}
  {{#each (get_methods_obj path)}}
    {{{render_template 'Route.hbs' this}}}
  {{/each}}
{{/each}}

type Params = Record<string, string | number | boolean>;
type Query = Record<string, string | number | boolean>;
type Body = Record<string, string | number | Date | boolean | object>;
type Payload = {
  query?: Query;
  params?: Params;
  body?: Body;
};

const isPresent = ([key]: [string, unknown]) => key !== null && key !== undefined;
function addPathParams(url: string, params: Params): string {
  return Object.entries(params)
    .filter(isPresent)
    .reduce((acc, [key, value]) => acc.replace(`{${key}}`, encodeURIComponent(value)), url);
}
function addQueryParams(url: string, query: Query): string {
  const queryStr = Object.entries(query)
    .filter(isPresent)
    .reduce((acc, [key, value]) => acc.concat([key, encodeURIComponent(value)]), [] as [string, string][])
    .join('&');
  return queryStr ? `${url}?${queryStr}` : `${url}`
}

export class ApiClient {
  constructor(private httpClient: AxiosInstance) {
  }

{{#each paths as |path url|}}
  {{#each (get_methods_obj path)}}
  async {{operationId}}(data: {{payload_name operationId}}): Promise<{{#if (get_value_by_key responses '200')}}{{response_name operationId}}{{else}}void{{/if}}> {
    const response = await this.httpClient.request({
      method: '{{@key}}',
      url: this.createUrl('{{url}}', data),
      data,
      headers: this.createHeaders(data),
    });
    return response.data;
  }
  {{/each}}

  private createUrl(url: string, data: Partial<Payload>) {
    const url = addPathParams(pattern, params ?? {});
    return addQueryParams(url, query ?? {});
  }

  private createHeaders(headers: Record<string, any>) {
    return headers;
  }
{{/each}}
}
