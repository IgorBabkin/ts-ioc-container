---
import { codeToHtml } from "shiki";

interface Props {
  code: string;
  lang?:
    | "typescript"
    | "ts"
    | "javascript"
    | "js"
    | "json"
    | "shell"
    | "bash"
    | "sh";
  filename?: string;
}

const { code, lang = "typescript", filename } = Astro.props;

// Normalize language aliases
const normalizedLang =
  lang === "ts"
    ? "typescript"
    : lang === "js"
      ? "javascript"
      : lang === "sh"
        ? "bash"
        : lang;

// Map shell/bash to the correct Shiki language
const shikiLang =
  normalizedLang === "shell" || normalizedLang === "bash"
    ? "bash"
    : normalizedLang;

const html = await codeToHtml(code, {
  lang: shikiLang,
  theme: "github-light",
});

// Generate a unique ID for this code block
const blockId = `code-block-${Math.random().toString(36).substring(2, 9)}`;
---

<div class="code-block" data-code-block-id={blockId}>
  <div class="code-block-header">
    {filename && <span class="code-block-filename">{filename}</span>}
    <button
      class="code-block-copy-btn"
      data-code={code}
      aria-label="Copy code to clipboard"
      title="Copy to clipboard"
    >
      <svg
        class="copy-icon"
        width="16"
        height="16"
        viewBox="0 0 16 16"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25v-7.5Z"
          fill="currentColor"></path>
        <path
          d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25v-7.5Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25h-7.5Z"
          fill="currentColor"></path>
      </svg>
      <svg
        class="check-icon"
        width="16"
        height="16"
        viewBox="0 0 16 16"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <path
          d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.75.75 0 0 1 1.06-1.06L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"
          fill="currentColor"></path>
      </svg>
      <span class="copy-text">Copy</span>
      <span class="copied-text">Copied!</span>
    </button>
  </div>
  <div class="code-block-content" set:html={html} />
</div>

<style>
  .code-block {
    margin: 1.5rem 0;
    border: 1px solid #e1e4e8;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    background: #ffffff;
    position: relative;
  }

  .code-block-header {
    background-color: #f6f8fa;
    border-bottom: 1px solid #e1e4e8;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    color: #586069;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
  }

  .code-block-filename {
    font-family:
      "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    flex: 1;
  }

  .code-block-copy-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.625rem;
    background: transparent;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    color: #586069;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family:
      -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue",
      Arial, sans-serif;
    line-height: 1;
  }

  .code-block-copy-btn:hover {
    background-color: #ffffff;
    border-color: #0366d6;
    color: #0366d6;
  }

  .code-block-copy-btn:active {
    transform: scale(0.98);
  }

  .code-block-copy-btn.copied {
    background-color: #dafbe1;
    border-color: #2ea043;
    color: #1a7f37;
  }

  .code-block-copy-btn .copy-icon,
  .code-block-copy-btn .check-icon {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
  }

  .code-block-copy-btn .check-icon {
    display: none;
  }

  .code-block-copy-btn.copied .copy-icon {
    display: none;
  }

  .code-block-copy-btn.copied .check-icon {
    display: block;
  }

  .code-block-copy-btn .copy-text,
  .code-block-copy-btn .copied-text {
    font-size: 0.75rem;
    font-weight: 500;
  }

  .code-block-copy-btn .copied-text {
    display: none;
  }

  .code-block-copy-btn.copied .copy-text {
    display: none;
  }

  .code-block-copy-btn.copied .copied-text {
    display: inline;
  }

  .code-block-content {
    overflow-x: auto;
    position: relative;
  }

  .code-block-content :global(pre) {
    margin: 0;
    padding: 1rem;
    background: transparent;
    border: none;
    overflow-x: auto;
  }

  .code-block-content :global(code) {
    font-family:
      "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    display: block;
    width: 100%;
  }
</style>

<script is:inline>
  (function () {
    function initCopyButtons() {
      const copyButtons = document.querySelectorAll(".code-block-copy-btn");

      copyButtons.forEach((button) => {
        if (button.dataset.initialized) return;
        button.dataset.initialized = "true";

        button.addEventListener("click", async function () {
          const code = this.getAttribute("data-code");
          if (!code) return;

          try {
            await navigator.clipboard.writeText(code);

            // Add copied state
            this.classList.add("copied");

            // Reset after 2 seconds
            setTimeout(() => {
              this.classList.remove("copied");
            }, 2000);
          } catch (err) {
            // Fallback for older browsers
            const textArea = document.createElement("textarea");
            textArea.value = code;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            document.body.appendChild(textArea);
            textArea.select();

            try {
              document.execCommand("copy");
              this.classList.add("copied");
              setTimeout(() => {
                this.classList.remove("copied");
              }, 2000);
            } catch (fallbackErr) {
              console.error("Failed to copy code:", fallbackErr);
            } finally {
              document.body.removeChild(textArea);
            }
          }
        });
      });
    }

    // Initialize on DOM ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initCopyButtons);
    } else {
      initCopyButtons();
    }

    // Also initialize for dynamically loaded content
    if (typeof window !== "undefined") {
      const observer = new MutationObserver(initCopyButtons);
      observer.observe(document.body, { childList: true, subtree: true });
    }
  })();
</script>
