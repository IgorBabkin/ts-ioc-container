---
import { codeToHtml } from "shiki";
import CopyButton from "./CopyButton.astro";

interface Props {
  code: string;
  lang?:
    | "typescript"
    | "ts"
    | "javascript"
    | "js"
    | "json"
    | "shell"
    | "bash"
    | "sh";
  filename?: string;
}
const { code, lang = "typescript", filename } = Astro.props;

// Format language for display
const langDisplayMap: Record<string, string> = {
  ts: "TypeScript",
  typescript: "TypeScript",
  js: "JavaScript",
  javascript: "JavaScript",
  json: "JSON",
  shell: "Shell",
  bash: "Bash",
  sh: "Shell",
};

const langDisplay = langDisplayMap[lang.toLowerCase()] || lang;

// Generate both light and dark HTML versions
const htmlLight = await codeToHtml(code, {
  lang,
  theme: "vitesse-light",
});

const htmlDark = await codeToHtml(code, {
  lang,
  theme: "vitesse-dark",
});
---

<div
  class="card mb-4"
>
  <div class="card-header d-flex justify-content-between align-items-center">
    <span class="badge bg-info">{langDisplay}</span>
    {filename && <span class="font-monospace small">{filename}</span>}
  </div>
  <div class="card-body p-0 code-block-content">
    <div class="copy-button-wrapper">
      <CopyButton code={code} />
    </div>
    <div class="code-block-light" set:html={htmlLight} />
    <div class="code-block-dark" set:html={htmlDark} />
  </div>
</div>

<style lang="css">
  .card-body {
    overflow: hidden;
    border-bottom-left-radius: var(--bs-border-radius);
    border-bottom-right-radius: var(--bs-border-radius);
  }

  .card-body :global(pre) {
    margin: 0;
    padding: 1rem;
    background: transparent;
    border: none;
    overflow-x: auto;
  }

  .card-body :global(code) {
    font-size: 0.875rem;
    display: block;
    width: 100%;
  }

  .code-block-content {
    position: relative;
  }

  .copy-button-wrapper {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    z-index: 10;
  }

  .code-block-light,
  .code-block-dark {
    width: 100%;
  }

  :global([data-bs-theme="light"]) .code-block-dark {
    display: none !important;
  }

  :global([data-bs-theme="dark"]) .code-block-light {
    display: none !important;
  }

  :global([data-bs-theme="dark"]) .code-block-dark {
    display: block !important;
  }

  :global([data-bs-theme="light"]) .code-block-light {
    display: block !important;
  }
</style>
